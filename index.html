<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pension Monte Carlo</title>
  <link rel="stylesheet" href="styles.css?v=4" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="simulation.js?v=4"></script>
</head>
<body>
  <header>
    <h1>Pension Monte Carlo</h1>
    <p class="tagline">Retire when pot hits threshold (e.g. age 57–63). 4% rule, income floor/ceiling, uni fees &amp; gifts. Today’s £. This is not financial advice.</p>
  </header>

  <main class="main-grid">
    <aside class="controls" id="controls">
      <h2>Assumptions</h2>
      <button type="button" id="runBtn">Run simulation</button>
      <div class="control-group">
        <div class="label-row">
          <label for="currentAgeNum">Current age</label>
          <span class="help-icon" data-help="Your age now. Simulation runs from this age to 90." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="currentAgeNum" min="25" max="60" step="1" value="50" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="startingPotNum">Starting pot (£)</label>
          <span class="help-icon" data-help="Total pension and investment pot today." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="startingPotNum" min="0" max="5000000" step="10000" value="300000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="annualContributionNum">Annual contribution (£)</label>
          <span class="help-icon" data-help="Amount you pay in each year until you retire." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="annualContributionNum" min="0" max="100000" step="1000" value="15000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="retirementThresholdNum">Retirement threshold (£)</label>
          <span class="help-icon" data-help="Retire when pot reaches this, or when pension income ≥ floor, or at latest age." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="retirementThresholdNum" min="0" max="5000000" step="10000" value="1000000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="earliestRetirementNum">Earliest retirement age</label>
          <span class="help-icon" data-help="You won't retire before this age." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="earliestRetirementNum" min="55" max="62" step="1" value="57" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="latestRetirementNum">Latest retirement age</label>
          <span class="help-icon" data-help="You must retire by this age if the pot hasn't hit the threshold." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="latestRetirementNum" min="60" max="68" step="1" value="68" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="incomeFloorNum">Income floor (£/yr)</label>
          <span class="help-icon" data-help="Minimum total income (withdrawal + any other pensions) you want each year. Surplus pension is added to the pot." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="incomeFloorNum" min="0" max="200000" step="1000" value="30000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="incomeCeilingNum">Income ceiling (£/yr)</label>
          <span class="help-icon" data-help="Maximum total income. Any pension above this is added to the pot." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="incomeCeilingNum" min="0" max="200000" step="1000" value="80000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="withdrawalRateNum">Withdrawal rate (%)</label>
          <span class="help-icon" data-help="Each year in retirement, target income = this % of pot, then clamped between floor and ceiling." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="withdrawalRateNum" min="1" max="10" step="0.25" value="4" />
      </div>

      <h3 class="control-section">Pensions</h3>
      <div class="control-group">
        <div class="label-row">
          <label for="pension1AgeNum">State pension age</label>
          <span class="help-icon" data-help="Age you start receiving the state pension." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="pension1AgeNum" min="66" max="70" step="1" value="68" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="pension1AmountNum">State pension (£/yr)</label>
          <span class="help-icon" data-help="State pension amount per year (today's £)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="pension1AmountNum" min="0" max="50000" step="500" value="12000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="pension2AgeNum">Your age when partner's pension starts</label>
          <span class="help-icon" data-help="Your age when your partner's pension begins (e.g. when they reach their pension age)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="pension2AgeNum" min="66" max="75" step="1" value="70" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="pension2AmountNum">Partner pension (£/yr)</label>
          <span class="help-icon" data-help="Partner's pension income per year (today's £). Counts toward your income floor/ceiling." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="pension2AmountNum" min="0" max="100000" step="500" value="12000" />
      </div>

      <h3 class="control-section">Defined benefit pensions</h3>
      <p class="control-hint">Add workplace or other DB pensions (start age + amount). They count toward your income floor/ceiling like state pension.</p>
      <div id="dbPensionsList" class="db-pensions-list"></div>
      <button type="button" id="addDbPensionBtn" class="add-db-btn">Add defined benefit pension</button>

      <h3 class="control-section">Partner DC pensions</h3>
      <p class="control-hint">Add partner DC pots: current value, your age when each becomes available for withdrawal, and yearly contribution. Tick to contribute until you retire, or set an age when contributions stop.</p>
      <div id="dcPensionsList" class="dc-pensions-list"></div>
      <button type="button" id="addDcPensionBtn" class="add-db-btn">Add partner DC pension</button>

      <h3 class="control-section">Children (0–4)</h3>
      <div class="control-group">
        <div class="label-row">
          <label for="numChildrenNum">Number of children</label>
          <span class="help-icon" data-help="How many children to model for uni and gifts." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="numChildrenNum" min="0" max="4" step="1" value="2" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="uniFeePerYearNum">Uni costs/year (£ per child)</label>
          <span class="help-icon" data-help="Annual cost per child while at uni (e.g. £9k)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="uniFeePerYearNum" min="0" max="30000" step="500" value="9000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="uniYearsNum">Uni years (per child)</label>
          <span class="help-icon" data-help="Number of years of uni fees per child (e.g. 4)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="uniYearsNum" min="1" max="6" step="1" value="4" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="giftAmountNum">Gift amount (£ per child)</label>
          <span class="help-icon" data-help="One-off gift to each child at the age you set (if pot is above min)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="giftAmountNum" min="0" max="1000000" step="10000" value="50000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="giftMinPotNum">Min pot to gift (£)</label>
          <span class="help-icon" data-help="Only give the gift if your pot is at least this much after the gift." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="giftMinPotNum" min="0" max="3000000" step="10000" value="700000" />
      </div>

      <div id="childBlock1" class="child-block">
        <h4 class="child-heading">Child 1</h4>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child1Uni" checked /> Goes to uni</label>
          <label for="child1UniAgeNum" class="sub-label">Your age when they turn 18</label>
          <input type="number" id="child1UniAgeNum" min="50" max="65" step="1" value="58" />
        </div>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child1Gift" checked /> Gets gift</label>
          <label for="child1GiftAgeNum" class="sub-label">Your age when you give gift</label>
          <input type="number" id="child1GiftAgeNum" min="65" max="80" step="1" value="70" />
        </div>
      </div>
      <div id="childBlock2" class="child-block">
        <h4 class="child-heading">Child 2</h4>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child2Uni" checked /> Goes to uni</label>
          <label for="child2UniAgeNum" class="sub-label">Your age when they turn 18</label>
          <input type="number" id="child2UniAgeNum" min="50" max="65" step="1" value="60" />
        </div>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child2Gift" checked /> Gets gift</label>
          <label for="child2GiftAgeNum" class="sub-label">Your age when you give gift</label>
          <input type="number" id="child2GiftAgeNum" min="65" max="80" step="1" value="72" />
        </div>
      </div>
      <div id="childBlock3" class="child-block">
        <h4 class="child-heading">Child 3</h4>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child3Uni" /> Goes to uni</label>
          <label for="child3UniAgeNum" class="sub-label">Your age when they turn 18</label>
          <input type="number" id="child3UniAgeNum" min="50" max="65" step="1" value="62" />
        </div>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child3Gift" /> Gets gift</label>
          <label for="child3GiftAgeNum" class="sub-label">Your age when you give gift</label>
          <input type="number" id="child3GiftAgeNum" min="65" max="80" step="1" value="74" />
        </div>
      </div>
      <div id="childBlock4" class="child-block">
        <h4 class="child-heading">Child 4</h4>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child4Uni" /> Goes to uni</label>
          <label for="child4UniAgeNum" class="sub-label">Your age when they turn 18</label>
          <input type="number" id="child4UniAgeNum" min="50" max="65" step="1" value="64" />
        </div>
        <div class="control-group">
          <label class="checkbox-label"><input type="checkbox" id="child4Gift" /> Gets gift</label>
          <label for="child4GiftAgeNum" class="sub-label">Your age when you give gift</label>
          <input type="number" id="child4GiftAgeNum" min="65" max="80" step="1" value="76" />
        </div>
      </div>

      <h3 class="control-section">Simulation</h3>
      <div class="control-group model-checkboxes">
        <div class="label-row">
          <label>Models to run</label>
          <span class="help-icon" data-help="Standard: single distribution each year (i.i.d.). Regime-switching: Markov chain with bull/bear states — returns cluster in regimes, producing more realistic fat tails. Tick both to compare side-by-side." aria-label="Help">ⓘ</span>
        </div>
        <label class="checkbox-label"><input type="checkbox" id="runStandard" checked /> Standard MC</label>
        <label class="checkbox-label"><input type="checkbox" id="runRegime" /> Regime-switching (Markov)</label>
      </div>
      <div id="standardReturnParams">
        <div class="control-group">
          <div class="label-row">
            <label for="realReturnNum">Expected real return (%)</label>
            <span class="help-icon" data-help="Assumed long-term real (inflation-adjusted) return, arithmetic mean. Typical range 5–7.5%. Default is 6% to result in a realistic 5% compound annual growth rate." aria-label="Help">ⓘ</span>
          </div>
          <input type="number" id="realReturnNum" min="0" max="15" step="0.5" value="6" />
        </div>
        <div class="control-group">
          <div class="label-row">
            <label for="volatilityNum">Volatility (%)</label>
            <span class="help-icon" data-help="Annual volatility of returns. Higher = more uncertainty. Typical 10–20%." aria-label="Help">ⓘ</span>
          </div>
          <input type="number" id="volatilityNum" min="5" max="40" step="1" value="16" />
        </div>
      </div>
      <div id="regimePanel" hidden>
        <div class="control-group">
          <div class="label-row">
            <label for="regimePreset">Preset</label>
            <span class="help-icon" data-help="Hardy 2-regime: calibrated to S&amp;P 500 (Hardy 2001). Conservative: lower means and vol." aria-label="Help">ⓘ</span>
          </div>
          <select id="regimePreset">
            <option value="hardy">Hardy 2-regime (S&amp;P 500)</option>
            <option value="conservative">Conservative 2-regime</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="regime-block">
          <h4 class="regime-heading">Bull regime</h4>
          <div class="control-group">
            <label for="bullMean">Mean return (%)</label>
            <input type="number" id="bullMean" min="-20" max="30" step="0.1" value="9.5" class="regime-input" />
          </div>
          <div class="control-group">
            <label for="bullVol">Volatility (%)</label>
            <input type="number" id="bullVol" min="1" max="50" step="0.1" value="12" class="regime-input" />
          </div>
          <div class="control-group">
            <label for="bullStay">Stay probability (%)</label>
            <input type="number" id="bullStay" min="50" max="99.9" step="0.1" value="96" class="regime-input" />
          </div>
        </div>
        <div class="regime-block">
          <h4 class="regime-heading">Bear regime</h4>
          <div class="control-group">
            <label for="bearMean">Mean return (%)</label>
            <input type="number" id="bearMean" min="-50" max="20" step="0.1" value="-5" class="regime-input" />
          </div>
          <div class="control-group">
            <label for="bearVol">Volatility (%)</label>
            <input type="number" id="bearVol" min="1" max="60" step="0.1" value="25" class="regime-input" />
          </div>
          <div class="control-group">
            <label for="bearStay">Stay probability (%)</label>
            <input type="number" id="bearStay" min="50" max="99.9" step="0.1" value="87" class="regime-input" />
          </div>
        </div>
        <div class="control-group">
          <div class="label-row">
            <label for="initialRegime">Initial regime</label>
            <span class="help-icon" data-help="Equilibrium: randomly picked based on long-run regime probabilities. Or force start in a specific regime." aria-label="Help">ⓘ</span>
          </div>
          <select id="initialRegime">
            <option value="equilibrium">Equilibrium distribution</option>
            <option value="bull">Start in Bull</option>
            <option value="bear">Start in Bear</option>
          </select>
        </div>
        <p id="equilibriumInfo" class="equilibrium-info"></p>
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="numRunsNum">Simulation runs</label>
          <span class="help-icon" data-help="More runs = smoother results but slower. 1000–5000 is usually enough." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="numRunsNum" min="100" max="10000" step="100" value="3000" />
      </div>
      <div class="control-group">
        <div class="label-row">
          <label for="chartYMax">Chart Y-axis max (£M)</label>
          <span class="help-icon" data-help="Leave empty for automatic scale. Set a value to fix the Y-axis (e.g. 2 for £2M)." aria-label="Help">ⓘ</span>
        </div>
        <input type="number" id="chartYMax" class="chart-y-max" min="0" step="0.5" placeholder="auto" />
      </div>
      <div class="control-group">
        <label><input type="checkbox" id="lockSeed" checked /> Lock seed (reproducible)</label>
      </div>
      <button type="button" id="runBtnBottom" class="run-btn run-btn-bottom">Run simulation</button>
    </aside>
    <div id="instructions" class="instructions"></div>
    <section class="results">
      <div id="loading" class="loading" hidden>Running simulation…</div>
      <div id="stats" class="stats">
        <div id="statsStandard">
          <p class="stat-model-label" id="stdLabel" hidden><strong>Standard MC</strong></p>
          <p><strong>Money lasts to 90:</strong> <span id="survivalPct">—</span>%</p>
          <p><strong>Ruin:</strong> <span id="ruinCount">—</span> runs</p>
          <p><strong>Median retirement age:</strong> <span id="medianRetAge">—</span></p>
          <p><strong>Median pot at retirement:</strong> £<span id="medianPotRet">—</span></p>
          <p><strong>Median estate at 90:</strong> £<span id="medianEstate">—</span></p>
        </div>
        <div id="statsRegime" hidden>
          <p class="stat-model-label"><strong>Regime-switching</strong></p>
          <p><strong>Money lasts to 90:</strong> <span id="regSurvivalPct">—</span>%</p>
          <p><strong>Ruin:</strong> <span id="regRuinCount">—</span> runs</p>
          <p><strong>Median retirement age:</strong> <span id="regMedianRetAge">—</span></p>
          <p><strong>Median pot at retirement:</strong> £<span id="regMedianPotRet">—</span></p>
          <p><strong>Median estate at 90:</strong> £<span id="regMedianEstate">—</span></p>
        </div>
        <p id="dbPensionsSummary" class="stat-db-summary" style="display:none"></p>
        <p id="dcPensionsSummary" class="stat-db-summary" style="display:none"></p>
        <p class="stat-note">Chart at a given age shows median pot across all runs at that age (so includes runs who retired earlier and have already drawn down).</p>
      </div>
      <div id="chartToggles" class="chart-toggles" hidden>
        <label class="toggle-label"><input type="checkbox" id="showStandardMC" checked /> Show Standard MC</label>
        <label class="toggle-label"><input type="checkbox" id="showRegimeMC" checked /> Show Regime-switching</label>
      </div>
      <div class="chart-wrap">
        <canvas id="portfolioChart" aria-label="Portfolio value by age"></canvas>
      </div>
      <details class="full-report-wrap">
        <summary>Full text report</summary>
        <pre id="fullReport" class="full-report"></pre>
      </details>
    </section>
  </main>

  <footer>
    <p>Same logic as <code>monte_carlo_threshold.py</code>. Uni fees, two gifts, state &amp; partner pensions. Not advice.</p>
  </footer>
  <div id="helpPopover" class="help-popover" role="tooltip" aria-live="polite" hidden></div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="app.js?v=4"></script>
</body>
</html>
